<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MHMA - أسعار الذهب</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f9fafb; color: #1f2937; }
    table { table-layout: fixed; width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #e5e7eb; padding: 0.75rem; }
    th { background: #eff6ff; }
    .status-circle { width: .75rem; height: .75rem; border-radius: 9999px; }
    .promo-blink { font-size: 1.5rem; color: #dc2626; animation: blink 1s linear infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
  </style>
</head>
<body class="text-gray-900">

  <header class="bg-blue-50 text-center py-10">
    <img src="logo.png" alt="MHMA Logo" class="mx-auto h-40"/>
    <h1 class="mt-4 text-3xl font-bold">MHMA Gold Outlet</h1>
  </header>

  <main class="px-4 py-8">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center justify-center mb-6 space-x-3">
        <span id="status-circle" class="status-circle bg-yellow-400"></span>
        <div id="current-time" class="bg-gray-100 px-4 py-2 rounded shadow-sm font-semibold">
          --:--:--
        </div>
      </div>

      <table class="w-full bg-white rounded shadow-sm mb-6">
        <thead>
          <tr>
            <th>العيار</th>
            <th>شراء</th>
            <th>بيع</th>
          </tr>
        </thead>
        <tbody id="gold-prices">
          <tr><td colspan="3" class="text-center py-4">جاري التحميل...</td></tr>
        </tbody>
      </table>

      <p class="text-center promo-blink">
        اشتر الآن بسعر الذهب + 40 ريال مصنعية فقط على جميع الأصناف
      </p>
    </div>
  </main>

  <footer class="bg-blue-50 text-center py-6 text-sm">
    <div class="space-y-1">
      <div>mhma-alarbash@outlook.com</div>
      <div>0530091668 / 0138997999</div>
      <div>Dammam – Al Faisaliah – West Avenue Mall – Gate 3</div>
    </div>
  </footer>

  <script>
    const statusEl = document.getElementById('status-circle');
    const timeEl   = document.getElementById('current-time');
    const pricesEl = document.getElementById('gold-prices');

    const GOLDAPI_KEY = 'goldapi-jzk9smbg824oq-io';
    const URL_USD     = 'https://www.goldapi.io/api/XAU/USD';
    const URL_SAR     = 'https://www.goldapi.io/api/XAU/SAR';
    const ADJ_API     = '/api/adjustments';
    const G_PER_OUNCE = 31.1035;

    function updateClock() {
      const now = new Date();
      timeEl.textContent = new Intl.DateTimeFormat('ar-EG', {
        hour: 'numeric', minute: '2-digit', second: '2-digit',
        hour12: true, timeZone: 'Asia/Riyadh'
      }).format(now);
    }

    async function fetchAdjustments() {
      try {
        const res = await fetch(ADJ_API, { cache: 'no-store' });
        if (!res.ok) return {};
        return await res.json();
      } catch {
        return {};
      }
    }

    async function fetchGoldAPI(url) {
      const res = await fetch(url, {
        method: 'GET',
        headers: { 'x-access-token': GOLDAPI_KEY },
        cache: 'no-store'
      });
      if (!res.ok) throw new Error('GoldAPI '+res.status);
      return res.json();
    }

    function buildRow(label, buy, sell, isOunce = false) {
      if (isOunce) {
        return `
          <tr>
            <td>${label}</td>
            <td dir="ltr">$ ${buy}</td>
            <td dir="ltr">$ ${sell}</td>
          </tr>`;
      } else {
        return `
          <tr>
            <td>${label}</td>
            <td dir="ltr">${buy} ريال</td>
            <td dir="ltr">${sell} ريال</td>
          </tr>`;
      }
    }

    async function updatePrices() {
      statusEl.className = 'status-circle bg-yellow-400';
      try {
        // 1) بيانات GoldAPI
        const [usd, sar, adj] = await Promise.all([
          fetchGoldAPI(URL_USD),
          fetchGoldAPI(URL_SAR),
          fetchAdjustments()
        ]);

        // 2) عرض Timestamp للتأكد من التحديث
        console.log('🕒 USD timestamp:', usd.timestamp);
        console.log('🕒 SAR timestamp:', sar.timestamp);
        console.log('🔧 adjustments:', adj);

        // 3) حساب الأونصة
        const bidO = parseFloat(usd.bid  ?? usd.price);
        const askO = parseFloat(usd.ask  ?? usd.price);
        let html = buildRow(
          'أونصة',
          (bidO + (adj.oz_buy  || 0)).toFixed(2),
          (askO + (adj.oz_sell || 0)).toFixed(2),
          true
        );

        // 4) حساب فروق الجرام
        const bidO_SAR = parseFloat(sar.bid ?? sar.price);
        const askO_SAR = parseFloat(sar.ask ?? sar.price);
        const spread   = (askO_SAR - bidO_SAR) / G_PER_OUNCE;

        [24, 22, 21, 18].forEach(k => {
          const mid   = parseFloat(sar[`price_gram_${k}k`] ?? 0);
          const buy   = (mid - spread * (k/24) + (adj[`${k}_buy`]  || 0)).toFixed(2);
          const sell  = (mid + spread * (k/24) + (adj[`${k}_sell`] || 0)).toFixed(2);
          html += buildRow(`عيار ${k}`, buy, sell);
        });

        pricesEl.innerHTML    = html;
        statusEl.className    = 'status-circle bg-green-500';
      } catch (e) {
        console.error('Error fetching prices:', e);
        pricesEl.innerHTML    =
          '<tr><td colspan="3" class="text-red-600 py-4">فشل في تحميل الأسعار</td></tr>';
        statusEl.className    = 'status-circle bg-red-500';
      }
    }

    // بداية
    updateClock();
    setInterval(updateClock, 1000);
    updatePrices();
    // انتظر دقيقة بين كل تحديث حتى تتجدد بيانات GoldAPI
    setInterval(updatePrices, 60_000);
  </script>

</body>
</html>
