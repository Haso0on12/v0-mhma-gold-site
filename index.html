<!DOCTYPE html>
<html lang="ar">
<head>…</head>
<body>
  <!-- … الرأس والستايل كما في مثالنا السابق … -->
  <table>…</table>
  <script>
    const circleEl = document.getElementById('status-circle');
    const timeEl   = document.getElementById('current-time');
    const tblEl    = document.getElementById('gold-prices');

    const GOLDAPI_KEY    = "goldapi-jzk9smbg824oq-io";
    const URLs = {
      USD: "https://www.goldapi.io/api/XAU/USD",
      SAR: "https://www.goldapi.io/api/XAU/SAR"
    };
    const ADJ_API = "/api/adjustments";
    const G = 31.1035;

    async function fetchJSON(url) {
      const r = await fetch(url, { headers:{ "x-access-token": GOLDAPI_KEY }});
      if (!r.ok) throw new Error(url + " → " + r.status);
      return r.json();
    }

    async function fetchAdjustments() {
      try {
        const r = await fetch(ADJ_API, { cache:"no-store" });
        return r.ok ? await r.json() : {};
      } catch {
        return {};
      }
    }

    function buildRow(buy, sell, label, isOunce) {
      if (isOunce) {
        return `<tr>
          <td dir="ltr">$ ${buy}</td><td dir="ltr">$ ${sell}</td>
          <td>${label}</td>
        </tr>`;
      }
      return `<tr>
        <td dir="ltr"><img src="Saudi_Riyal_Symbol.png" class="inline w-5 h-5 mr-1"/>${buy}</td>
        <td dir="ltr"><img src="Saudi_Riyal_Symbol.png" class="inline w-5 h-5 mr-1"/>${sell}</td>
        <td>${label}</td>
      </tr>`;
    }

    async function updatePrices() {
      circleEl.className = 'status-circle bg-yellow-400';
      try {
        // 1) جلب دفعة USD و SAR من GoldAPI
        const [usd, sar] = await Promise.all([
          fetchJSON(URLs.USD),
          fetchJSON(URLs.SAR)
        ]);

        // 2) جلب التعديلات
        const adj = await fetchAdjustments();

        // 3) حساب سعر الأونصة
        const bidO = parseFloat(usd.bid ?? usd.price),
              askO = parseFloat(usd.ask ?? usd.price);
        let html = buildRow(
          (bidO + (adj.oz_buy||0)).toFixed(2),
          (askO + (adj.oz_sell||0)).toFixed(2),
          'أونصة', true
        );

        // 4) حساب فروق الجرام لكل عيار
        const sarBidO = parseFloat(sar.bid ?? sar.price),
              sarAskO = parseFloat(sar.ask ?? sar.price),
              spread = (sarAskO - sarBidO) / G;

        [24,22,21,18].forEach(k => {
          const mid   = parseFloat(sar[`price_gram_${k}k`]  || 0);
          const buy   = (mid - spread*(k/24) + (adj[`${k}_buy`]||0)).toFixed(2);
          const sell  = (mid + spread*(k/24) + (adj[`${k}_sell`]||0)).toFixed(2);
          html += buildRow(buy, sell, `عيار ${k}`, false);
        });

        tblEl.innerHTML    = html;
        circleEl.className = 'status-circle bg-green-500';
      } catch (err) {
        console.error(err);
        tblEl.innerHTML    = `<tr><td colspan="3">فشل في تحميل الأسعار</td></tr>`;
        circleEl.className = 'status-circle bg-red-500';
      }
    }

    updatePrices();
    setInterval(updatePrices, 5000);
  </script>
</body>
</html>
